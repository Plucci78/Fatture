<!DOCTYPE html>
<html lang="it">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Elenco Fatture</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --secondary-color: #f39c12;
            --accent-color: #27ae60;
            --background-light: #f8f9fa;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        body { 
            padding-bottom: 5rem; 
            background-color: var(--background-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        main { 
            max-width: 1200px; 
            margin: 2rem auto; 
            padding: 0; 
            background-color: white; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow);
        }
        
        article { 
            margin: 0; 
            padding: 2rem; 
            border-bottom: 1px solid #e0e0e0; 
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .filter-box {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            align-items: end;
            flex-wrap: wrap;
        }
        
        .filter-box label {
            flex: 1;
            min-width: 200px;
        }
        
        .action-buttons button {
            margin-left: 0.5rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
            padding: 0.75rem;
        }
        
        table td {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        
        table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
        }
        
        .status-pagata {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-da-pagare {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-scaduta {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .nav-tabs {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0 0 2rem 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .nav-tabs li {
            margin-right: 0.5rem;
        }
        
        .nav-tabs a {
            display: block;
            padding: 0.5rem 1rem;
            text-decoration: none;
            color: #495057;
            border-radius: 4px 4px 0 0;
        }
        
        .nav-tabs a.active {
            background-color: var(--primary-color);
            color: white;
            border: 1px solid var(--primary-color);
        }
        
        .nav-tabs a:hover:not(.active) {
            background-color: #e9ecef;
        }
        
        /* Stili per modali */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            overflow: auto;
        }
        
        .modal-content {
            position: relative;
            background-color: #fff;
            margin: 10% auto;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            max-width: 600px;
            box-shadow: var(--box-shadow);
            animation: modalshow 0.3s ease;
        }
        
        @keyframes modalshow {
            from {transform: scale(0.8); opacity: 0;}
            to {transform: scale(1); opacity: 1;}
        }
        
        .close {
            position: absolute;
            top: 0.75rem;
            right: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
        }
        
        .status-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .status-filter button {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            background-color: #eee;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .status-filter button.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .action-icon {
            cursor: pointer;
            color: var(--primary-color);
            margin-right: 0.5rem;
            font-size: 1.1rem;
        }
        
        .action-icon:hover {
            color: var(--primary-hover);
        }
        
        .loader {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <main>
        <article>
            <header>
                <div>
                    <h2><i class="fas fa-file-invoice"></i> Elenco Fatture</h2>
                    <p>Visualizza, modifica e invia fatture ai condomini</p>
                </div>
                <div>
                    <a href="<?= getScriptUrl() ?>?page=new" role="button" class="secondary">
                        <i class="fas fa-plus"></i> Nuova Fattura
                    </a>
                </div>
            </header>
            
            <ul class="nav-tabs">
                <li><a href="#" class="active" data-tab="all">Tutte le fatture</a></li>
                <li><a href="#" data-tab="da-pagare">Da Pagare</a></li>
                <li><a href="#" data-tab="pagate">Pagate</a></li>
                <li><a href="#" data-tab="scadute">Scadute</a></li>
            </ul>
            
            <div class="filter-box">
                <label for="filterCondominio">
                    <i class="fas fa-building"></i> Condominio
                    <select id="filterCondominio">
                        <option value="">Tutti i condomini</option>
                        <!-- Verrà popolato dinamicamente -->
                    </select>
                </label>
                
                <label for="filterAppartamento">
                    <i class="fas fa-home"></i> Appartamento
                    <select id="filterAppartamento" disabled>
                        <option value="">Tutti gli appartamenti</option>
                        <!-- Verrà popolato dinamicamente -->
                    </select>
                </label>
                
                <label for="filterPeriodo">
                    <i class="fas fa-calendar"></i> Periodo
                    <select id="filterPeriodo">
                        <option value="">Tutti i periodi</option>
                        <option value="current-month">Mese corrente</option>
                        <option value="last-month">Mese scorso</option>
                        <option value="last-3-months">Ultimi 3 mesi</option>
                        <option value="last-6-months">Ultimi 6 mesi</option>
                        <option value="last-year">Ultimo anno</option>
                    </select>
                </label>
                
                <button type="button" id="applyFilters">
                    <i class="fas fa-filter"></i> Applica Filtri
                </button>
            </div>
            
            <div id="statusMessage" class="status" style="display: none;"></div>
            
            <div id="tableContainer">
                <table id="fattureTbl">
                    <thead>
                        <tr>
                            <th>ID Fattura</th>
                            <th>Condominio</th>
                            <th>Intestatario</th>
                            <th>Data Emissione</th>
                            <th>Data Scadenza</th>
                            <th>Importo</th>
                            <th>Stato</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="fattureBody">
                        <tr>
                            <td colspan="8" style="text-align: center;">Caricamento fatture...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </article>
    </main>
    
    <!-- Modale per l'invio Email -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('emailModal')">&times;</span>
            <h3><i class="fas fa-envelope"></i> Invia Fattura via Email</h3>
            
            <div style="margin-bottom: 1.5rem;">
                <p><strong>Fattura:</strong> <span id="modalFatturaId"></span></p>
                <p><strong>Intestatario:</strong> <span id="modalIntestatario"></span></p>
            </div>
            
            <form id="emailForm">
                <input type="hidden" id="emailFatturaId">
                
                <label for="emailDestinatario">
                    <i class="fas fa-user"></i> Destinatario:
                    <input type="email" id="emailDestinatario" required>
                </label>
                
                <label for="emailCc">
                    <i class="fas fa-user-plus"></i> CC:
                    <input type="email" id="emailCc">
                </label>
                
                <label for="emailOggetto">
                    <i class="fas fa-heading"></i> Oggetto:
                    <input type="text" id="emailOggetto" required>
                </label>
                
                <label for="emailMessaggio">
                    <i class="fas fa-comment-alt"></i> Messaggio:
                    <textarea id="emailMessaggio" rows="6" required></textarea>
                </label>
                
                <div style="margin-top: 1.5rem; text-align: right;">
                    <button type="button" onclick="closeModal('emailModal')" class="secondary">Annulla</button>
                    <button type="submit" id="sendEmailBtn">
                        <i class="fas fa-paper-plane"></i> Invia Email
                    </button>
                </div>
            </form>
            
            <div id="emailStatusMsg" class="status" style="display: none; margin-top: 1rem;"></div>
        </div>
    </div>
    
    <!-- Modale per la modifica dello stato -->
    <div id="statoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('statoModal')">&times;</span>
            <h3><i class="fas fa-edit"></i> Modifica Stato Fattura</h3>
            
            <div style="margin-bottom: 1.5rem;">
                <p><strong>Fattura:</strong> <span id="modalStatoFatturaId"></span></p>
                <p><strong>Intestatario:</strong> <span id="modalStatoIntestatario"></span></p>
                <p><strong>Stato Attuale:</strong> <span id="modalStatoAttuale"></span></p>
            </div>
            
            <form id="statoForm">
                <input type="hidden" id="statoFatturaId">
                
                <label for="statoNuovo">
                    <i class="fas fa-tag"></i> Nuovo Stato:
                    <select id="statoNuovo" required>
                        <option value="">Seleziona nuovo stato</option>
                        <option value="Da Pagare">Da Pagare</option>
                        <option value="Pagata">Pagata</option>
                        <option value="Scaduta">Scaduta</option>
                        <option value="Annullata">Annullata</option>
                    </select>
                </label>
                
                <label for="statoNote">
                    <i class="fas fa-sticky-note"></i> Note (opzionale):
                    <textarea id="statoNote" rows="2"></textarea>
                </label>
                
                <div style="margin-top: 1.5rem; text-align: right;">
                    <button type="button" onclick="closeModal('statoModal')" class="secondary">Annulla</button>
                    <button type="submit" id="updateStatusBtn">
                        <i class="fas fa-save"></i> Aggiorna Stato
                    </button>
                </div>
            </form>
            
            <div id="statoStatusMsg" class="status" style="display: none; margin-top: 1rem;"></div>
        </div>
    </div>

    <script>
        // Riferimenti globali
        let allFatture = [];
        let allCondomini = [];
        let allAppartamenti = [];
        let currentTab = 'all';
        
        // Al caricamento del documento
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Pagina elenco fatture caricata");
            
            // Gestori eventi per i tab di navigazione
            document.querySelectorAll('.nav-tabs a').forEach(function(tab) {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Cambia tab attivo
                    document.querySelectorAll('.nav-tabs a').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Aggiorna visualizzazione
                    currentTab = this.getAttribute('data-tab');
                    filterFatture();
                });
            });
            
            // Gestore filtro condominio
            document.getElementById('filterCondominio').addEventListener('change', function() {
                const condominioId = this.value;
                const appartamentoSelect = document.getElementById('filterAppartamento');
                
                // Reset appartamenti
                appartamentoSelect.innerHTML = '<option value="">Tutti gli appartamenti</option>';
                
                if (condominioId) {
                    // Filtra appartamenti per condominio
                    const filteredApps = allAppartamenti.filter(app => 
                        String(app.condominioId) === String(condominioId)
                    );
                    
                    filteredApps.forEach(app => {
                        const option = document.createElement('option');
                        option.value = app.id;
                        option.textContent = app.nome;
                        appartamentoSelect.appendChild(option);
                    });
                    
                    appartamentoSelect.disabled = false;
                } else {
                    appartamentoSelect.disabled = true;
                }
            });
            
            // Gestore pulsante applica filtri
            document.getElementById('applyFilters').addEventListener('click', filterFatture);
            
            // Gestore form invio email
            document.getElementById('emailForm').addEventListener('submit', function(e) {
                e.preventDefault();
                inviaEmailFattura();
            });
            
            // Gestore form modifica stato
            document.getElementById('statoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                aggiornaStatoFattura();
            });
            
            // Carica dati
            caricaDati();
        });
        
        /**
         * Carica tutti i dati necessari
         */
        function caricaDati() {
            // Mostra messaggio di caricamento
            showStatus("Caricamento dati in corso...", "loading");
            
            // 1. Carica condomini
            google.script.run
                .withSuccessHandler(function(condomini) {
                    allCondomini = condomini || [];
                    popolaFiltroCondomini();
                })
                .withFailureHandler(handleError)
                .getCondominiList();
                
            // 2. Carica appartamenti
            google.script.run
                .withSuccessHandler(function(appartamenti) {
                    allAppartamenti = appartamenti || [];
                })
                .withFailureHandler(handleError)
                .getAppartamentiData();
                
            // 3. Carica fatture
            google.script.run
                .withSuccessHandler(function(fatture) {
                    allFatture = fatture || [];
                    hideStatus();
                    renderFatture();
                })
                .withFailureHandler(handleError)
                .getFattureList();
        }
        
        /**
         * Popola il filtro dei condomini
         */
        function popolaFiltroCondomini() {
            const select = document.getElementById('filterCondominio');
            select.innerHTML = '<option value="">Tutti i condomini</option>';
            
            allCondomini.forEach(condominio => {
                const option = document.createElement('option');
                option.value = condominio.id;
                option.textContent = condominio.nome;
                select.appendChild(option);
            });
        }
        
        /**
         * Filtra e visualizza le fatture in base ai criteri selezionati
         */
        function filterFatture() {
            const condominioId = document.getElementById('filterCondominio').value;
            const appartamentoId = document.getElementById('filterAppartamento').value;
            const periodoFilter = document.getElementById('filterPeriodo').value;
            
            // Filtra per stato (tab corrente)
            let filteredFatture = [...allFatture];
            
            if (currentTab === 'da-pagare') {
                filteredFatture = filteredFatture.filter(f => f.stato === 'Da Pagare');
            } else if (currentTab === 'pagate') {
                filteredFatture = filteredFatture.filter(f => f.stato === 'Pagata');
            } else if (currentTab === 'scadute') {
                filteredFatture = filteredFatture.filter(f => f.stato === 'Scaduta');
            }
            
            // Filtra per condominio
            if (condominioId) {
                filteredFatture = filteredFatture.filter(f => {
                    const appartamento = allAppartamenti.find(a => a.id === f.idAppartamento);
                    return appartamento && String(appartamento.condominioId) === String(condominioId);
                });
            }
            
            // Filtra per appartamento
            if (appartamentoId) {
                filteredFatture = filteredFatture.filter(f => f.idAppartamento === appartamentoId);
            }
            
            // Filtra per periodo
            if (periodoFilter) {
                const today = new Date();
                let startDate = new Date();
                
                if (periodoFilter === 'current-month') {
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                } else if (periodoFilter === 'last-month') {
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                } else if (periodoFilter === 'last-3-months') {
                    startDate = new Date(today.getFullYear(), today.getMonth() - 3, 1);
                } else if (periodoFilter === 'last-6-months') {
                    startDate = new Date(today.getFullYear(), today.getMonth() - 6, 1);
                } else if (periodoFilter === 'last-year') {
                    startDate = new Date(today.getFullYear() - 1, today.getMonth(), 1);
                }
                
                filteredFatture = filteredFatture.filter(f => {
                    const dataEmissione = new Date(f.dataEmissione);
                    return dataEmissione >= startDate && dataEmissione <= today;
                });
            }
            
            // Renderizza le fatture filtrate
            renderFatture(filteredFatture);
        }
        
        /**
         * Renderizza le fatture nella tabella
         */
        function renderFatture(fatture = allFatture) {
            const tbody = document.getElementById('fattureBody');
            
            if (!fatture || fatture.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nessuna fattura trovata</td></tr>';
                return;
            }
            
            // Ordina per data di emissione (più recenti prima)
            fatture.sort((a, b) => new Date(b.dataEmissione) - new Date(a.dataEmissione));
            
            tbody.innerHTML = '';
            fatture.forEach(fattura => {
                // Trova il nome del condominio
                const appartamento = allAppartamenti.find(a => a.id === fattura.idAppartamento);
                const condominio = allCondomini.find(c => 
                    appartamento && String(c.id) === String(appartamento?.condominioId)
                );
                
                // Formatta date
                const formatDate = (dateStr) => {
                    if (!dateStr) return "N/D";
                    const dateParts = dateStr.split('-');
                    if (dateParts.length === 3) {
                        return `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                    }
                    return dateStr;
                };
                
                // Determina classe CSS per lo stato
                let statusClass = '';
                if (fattura.stato === 'Pagata') {
                    statusClass = 'status-pagata';
                } else if (fattura.stato === 'Da Pagare') {
                    statusClass = 'status-da-pagare';
                } else if (fattura.stato === 'Scaduta') {
                    statusClass = 'status-scaduta';
                }
                
                // Crea riga tabella
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fattura.id}</td>
                    <td>${condominio ? condominio.nome : 'N/D'}</td>
                    <td>${fattura.intestatario || 'N/D'}</td>
                    <td>${formatDate(fattura.dataEmissione)}</td>
                    <td>${formatDate(fattura.dataScadenza)}</td>
                    <td>${fattura.importoTotale.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})} €</td>
                    <td><span class="status-badge ${statusClass}">${fattura.stato}</span></td>
                    <td>
                        <i class="fas fa-envelope action-icon" title="Invia Email" onclick="openEmailModal('${fattura.id}')"></i>
                        <i class="fas fa-edit action-icon" title="Modifica Stato" onclick="openStatoModal('${fattura.id}')"></i>
                        <i class="fas fa-eye action-icon" title="Visualizza PDF" onclick="visualizzaPdf('${fattura.id}')"></i>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        /**
         * Apre il modale per l'invio email
         */
        function openEmailModal(fatturaId) {
            const fattura = allFatture.find(f => f.id === fatturaId);
            if (!fattura) return;
            
            // Popola il modale
            document.getElementById('modalFatturaId').textContent = fattura.id;
            document.getElementById('modalIntestatario').textContent = fattura.intestatario;
            document.getElementById('emailFatturaId').value = fattura.id;
            document.getElementById('emailDestinatario').value = fattura.email || '';
            document.getElementById('emailOggetto').value = `Fattura ${fattura.id} - ${fattura.intestatario}`;
            
            // Testo predefinito per l'email
            const testoPredefinitoEmail = `Gentile ${fattura.intestatario},

In allegato trova la fattura ${fattura.id} relativa al periodo ${formatDate(fattura.dataInizio)} - ${formatDate(fattura.dataFine)}.

Importo totale: ${fattura.importoTotale.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2})} €
Scadenza pagamento: ${formatDate(fattura.dataScadenza)}
Metodo di pagamento: ${fattura.metodoPagamento || 'N/D'}

Per qualsiasi chiarimento, non esiti a contattarci.

Cordiali saluti,
Amministrazione Condominio`;

            document.getElementById('emailMessaggio').value = testoPredefinitoEmail;
            
            // Mostra il modale
            document.getElementById('emailModal').style.display = 'block';
        }
        
        /**
         * Apre il modale per la modifica dello stato
         */
        function openStatoModal(fatturaId) {
            const fattura = allFatture.find(f => f.id === fatturaId);
            if (!fattura) return;
            
            // Popola il modale
            document.getElementById('modalStatoFatturaId').textContent = fattura.id;
            document.getElementById('modalStatoIntestatario').textContent = fattura.intestatario;
            document.getElementById('modalStatoAttuale').textContent = fattura.stato;
            document.getElementById('statoFatturaId').value = fattura.id;
            document.getElementById('statoNuovo').value = fattura.stato;
            
            // Mostra il modale
            document.getElementById('statoModal').style.display = 'block';
        }
        
        /**
         * Chiude un modale
         */
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // Reset status message
            if (modalId === 'emailModal') {
                document.getElementById('emailStatusMsg').style.display = 'none';
            } else if (modalId === 'statoModal') {
                document.getElementById('statoStatusMsg').style.display = 'none';
            }
        }
        
        /**
         * Invia la fattura via email
         */
        function inviaEmailFattura() {
            const fatturaId = document.getElementById('emailFatturaId').value;
            const destinatario = document.getElementById('emailDestinatario').value;
            const cc = document.getElementById('emailCc').value;
            const oggetto = document.getElementById('emailOggetto').value;
            const messaggio = document.getElementById('emailMessaggio').value;
            
            // Validazione
            if (!destinatario) {
                showModalStatus('emailStatusMsg', "Inserisci l'indirizzo email del destinatario", "error");
                return;
            }
            
            if (!oggetto) {
                showModalStatus('emailStatusMsg', "Inserisci l'oggetto dell'email", "error");
                return;
            }
            
            // Mostra stato di caricamento
            showModalStatus('emailStatusMsg', "Invio email in corso...", "loading");
            
            // Disabilita pulsante
            document.getElementById('sendEmailBtn').disabled = true;
            
            // Dati email
            const emailData = {
                fatturaId: fatturaId,
                destinatario: destinatario,
                cc: cc,
                oggetto: oggetto,
                messaggio: messaggio
            };
            
            // Invia richiesta al backend
            google.script.run
                .withSuccessHandler(function(response) {
                    document.getElementById('sendEmailBtn').disabled = false;
                    
                    if (response.success) {
                        showModalStatus('emailStatusMsg', "Email inviata con successo!", "success");
                        // Chiudi automaticamente dopo 2 secondi
                        setTimeout(() => closeModal('emailModal'), 2000);
                    } else {
                        showModalStatus('emailStatusMsg', "Errore: " + (response.error || "Errore sconosciuto"), "error");
                    }
                })
                .withFailureHandler(function(error) {
                    document.getElementById('sendEmailBtn').disabled = false;
                    showModalStatus('emailStatusMsg', "Errore: " + (error.message || "Errore sconosciuto"), "error");
                })
                .inviaFatturaViaEmail(emailData);
        }
        
        /**
         * Aggiorna lo stato della fattura
         */
        function aggiornaStatoFattura() {
            const fatturaId = document.getElementById('statoFatturaId').value;
            const nuovoStato = document.getElementById('statoNuovo').value;
            const note = document.getElementById('statoNote').value;
            
            // Validazione
            if (!nuovoStato) {
                showModalStatus('statoStatusMsg', "Seleziona il nuovo stato della fattura", "error");
                return;
            }
            
            // Mostra stato di caricamento
            showModalStatus('statoStatusMsg', "Aggiornamento stato in corso...", "loading");
            
            // Disabilita pulsante
            document.getElementById('updateStatusBtn').disabled = true;
            
            // Dati per l'aggiornamento
            const statoData = {
                fatturaId: fatturaId,
                stato: nuovoStato,
                note: note
            };
            
            // Invia richiesta al backend
            google.script.run
                .withSuccessHandler(function(response) {
                    document.getElementById('updateStatusBtn').disabled = false;
                    
                    if (response.success) {
                        showModalStatus('statoStatusMsg', "Stato aggiornato con successo!", "success");
                        
                        // Aggiorna la fattura nella lista
                        const fattura = allFatture.find(f => f.id === fatturaId);
                        if (fattura) {
                            fattura.stato = nuovoStato;
                        }
                        
                        // Aggiorna la visualizzazione
                        renderFatture();
                        
                        // Chiudi automaticamente dopo 2 secondi
                        setTimeout(() => closeModal('statoModal'), 2000);
                    } else {
                        showModalStatus('statoStatusMsg', "Errore: " + (response.error || "Errore sconosciuto"), "error");
                    }
                })
                .withFailureHandler(function(error) {
                    document.getElementById('updateStatusBtn').disabled = false;
                    showModalStatus('statoStatusMsg', "Errore: " + (error.message || "Errore sconosciuto"), "error");
                })
                .aggiornaStatoFattura(statoData);
        }
        
        /**
         * Visualizza il PDF della fattura
         */
        function visualizzaPdf(fatturaId) {
            // Apri finestra con il PDF
            const pdfUrl = `<?= getScriptUrl() ?>?view=pdf&id=${fatturaId}`;
            window.open(pdfUrl, '_blank');
        }
        
        /**
         * Mostra un messaggio di stato nei modali
         */
        function showModalStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (!message) {
                element.style.display = 'none';
                return;
            }
            
            if (type === 'loading') {
                element.innerHTML = `<div style="display: flex; align-items: center; justify-content: center;"><span class="loader"></span><span style="margin-left: 0.5rem;">${message}</span></div>`;
            } else {
                element.textContent = message;
            }
            
            element.style.display = 'block';
            
            // Rimuovi tutte le classi di stato
            element.classList.remove('error', 'success', 'loading');
            
            // Aggiungi la classe appropriata
            if (type) {
                element.classList.add(type);
            }
        }
        
        /**
         * Mostra un messaggio di stato nella pagina principale
         */
        function showStatus(message, type) {
            const statusMsg = document.getElementById('statusMessage');
            if (!message) {
                statusMsg.style.display = 'none';
                return;
            }
            
            if (type === 'loading') {
                statusMsg.innerHTML = `<div style="display: flex; align-items: center; justify-content: center;"><span class="loader"></span><span style="margin-left: 0.5rem;">${message}</span></div>`;
            } else {
                statusMsg.textContent = message;
            }
            
            statusMsg.style.display = 'block';
            
            // Rimuovi tutte le classi di stato
            statusMsg.classList.remove('error', 'success', 'loading');
            
            // Aggiungi la classe appropriata
            if (type) {
                statusMsg.classList.add(type);
            }
        }
        
        /**
         * Nasconde il messaggio di stato
         */
        function hideStatus() {
            document.getElementById('statusMessage').style.display = 'none';
        }
        
        /**
         * Gestisce gli errori generali
         */
        function handleError(error) {
            console.error("Errore:", error);
            showStatus("Errore: " + (error.message || "Si è verificato un errore imprevisto"), "error");
        }
        
        /**
         * Formatta una data in formato italiano
         */
        function formatDate(dateStr) {
            if (!dateStr) return "N/D";
            const dateParts = dateStr.split('-');
            if (dateParts.length === 3) {
                return `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
            }
            return dateStr;
        }
    </script>
</body>
</html>
